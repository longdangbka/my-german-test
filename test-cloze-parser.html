<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOZE Parser Test</title>
</head>
<body>
    <h1>Testing CLOZE Parser with LaTeX</h1>
    <div id="test-results"></div>

    <script type="module">
        // Simple test function for parseClozeMarkers
        function parseClozeMarkers(text) {
            const markers = [];
            let i = 0;
            
            while (i < text.length) {
                // Look for opening braces
                if (text[i] === '{' && text[i + 1] === '{') {
                    // Double brace marker {{...}}
                    const start = i;
                    i += 2; // Skip opening {{
                    let content = '';
                    let braceCount = 1; // We've seen one opening {{
                    let inLaTeX = false;
                    
                    while (i < text.length && braceCount > 0) {
                        const char = text[i];
                        
                        if (char === '$' && !inLaTeX) {
                            // Starting LaTeX mode
                            inLaTeX = true;
                            content += char;
                        } else if (char === '$' && inLaTeX) {
                            // Ending LaTeX mode
                            inLaTeX = false;
                            content += char;
                        } else if (!inLaTeX && char === '}' && text[i + 1] === '}') {
                            // End of double brace marker (only if not in LaTeX)
                            braceCount--;
                            if (braceCount === 0) {
                                i += 2; // Skip closing }}
                                break;
                            }
                        } else {
                            content += char;
                        }
                        i++;
                    }
                    
                    if (braceCount === 0) {
                        markers.push({
                            match: `{{${content}}}`,
                            content: content,
                            start: start,
                            end: i
                        });
                    } else {
                        // Unmatched braces, treat as regular text
                        i = start + 1;
                    }
                } else if (text[i] === '{' && text[i + 1] !== '{') {
                    // Single brace marker {...}
                    const start = i;
                    i += 1; // Skip opening {
                    let content = '';
                    let braceCount = 1;
                    let inLaTeX = false;
                    
                    while (i < text.length && braceCount > 0) {
                        const char = text[i];
                        
                        if (char === '$' && !inLaTeX) {
                            inLaTeX = true;
                            content += char;
                        } else if (char === '$' && inLaTeX) {
                            inLaTeX = false;
                            content += char;
                        } else if (!inLaTeX && char === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                i++;
                                break;
                            }
                        } else {
                            content += char;
                        }
                        i++;
                    }
                    
                    if (braceCount === 0) {
                        markers.push({
                            match: `{${content}}`,
                            content: content,
                            start: start,
                            end: i
                        });
                    } else {
                        // Unmatched braces, treat as regular text
                        i = start + 1;
                    }
                } else {
                    i++;
                }
            }
            
            return markers;
        }

        // Test cases
        const testCases = [
            {
                input: "{{Machen $x=1$}} Sie bitte",
                expected: ["Machen $x=1$"]
            },
            {
                input: "Text with {{word}} and {{phrase $y=2$}} more text",
                expected: ["word", "phrase $y=2$"]
            },
            {
                input: "{simple} and {{complex $z=5+1$}} test",
                expected: ["simple", "complex $z=5+1$"]
            },
            {
                input: "$$x=5$$ {{answer $a=b$}} more $$y=6$$",
                expected: ["answer $a=b$"]
            }
        ];

        const resultsDiv = document.getElementById('test-results');
        
        testCases.forEach((testCase, index) => {
            const result = parseClozeMarkers(testCase.input);
            const extracted = result.map(r => r.content);
            const passed = JSON.stringify(extracted) === JSON.stringify(testCase.expected);
            
            const div = document.createElement('div');
            div.style.marginBottom = '10px';
            div.style.padding = '10px';
            div.style.border = passed ? '2px solid green' : '2px solid red';
            div.innerHTML = `
                <strong>Test ${index + 1}: ${passed ? 'PASS' : 'FAIL'}</strong><br>
                Input: ${testCase.input}<br>
                Expected: ${JSON.stringify(testCase.expected)}<br>
                Got: ${JSON.stringify(extracted)}<br>
                Full result: ${JSON.stringify(result, null, 2)}
            `;
            resultsDiv.appendChild(div);
        });
    </script>
</body>
</html>
